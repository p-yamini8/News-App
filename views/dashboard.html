<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Details</title>
    <link rel="stylesheet" href="./dashboard.css">

</head>
<body>

<div id="head">
    <h1>News Express</h1>
</div>

<nav>
   <div class="nav-scroll">
    <a href="dashboard.html">News</a>
    <a href="./politics/politics.html">Politics</a>
    <a href="./business/business.html">Business</a>
    <a href="./fun/fun.html">Fun</a>
    <a href="./sports/sports.html">Sports</a>
    <a href="./movies/movies.html">Movies</a>
    <a href="admin.html">Post</a>
</div>
<button id="account-btn">Account</button>
    </nav>

   <div id="account-details" style="display: none; margin-top:15px; max-height:500px; overflow-y:auto;">
 
      
        <h3>Your Account</h3>
     Profile Image
<img id="profile-img" src="./default-user.png"
  style="width:90px;height:90px;border-radius:50%;border:2px solid #444;margin-bottom:10px;">
<br>

<input type="file" id="profile-file" style="display:none;">
<button id="addprofile-image">Add Image</button>

        <p><strong>Name:</strong> <span id="acc-name"></span></p>
        <p><strong>Email:</strong> <span id="acc-email"></span></p>
       
         <button id="edit-profile-btn">Edit Profile</button>
         <hr>

        <!-- Saved Posts Section-->
        <div class="section-box">
            <h3 onclick="toggleSection('saved-section')">üìå Saved Posts</h3>
            <div id="saved-section" class="hidden">
                <ol id="saved-list"></ol>
                <button onclick="loadSavedPosts()">Load Saved Posts</button>
                <ol id="saved-Posts"></ol>
            </div>
        </div>

        <!-- User Posts -->
      <div class="section-box">
    <h3 onclick="toggleSection('myposts-section')">üìù Your Posts</h3>

    <div class="scroll-box" id="myposts-section" class="hidden">

        
        <div id="myposts-list"></div>    <!-- Posts should appear here -->
        

        <button onclick="loadMyPosts()">Load Your Posts</button>
    </div>
</div>

        <!-- Likes -->
        <div class="section-box">
            <h3 onclick="toggleSection('likes-section')">‚ù§ Likes</h3>
            <div id="likes-section" class="hidden">
                <p>Total Likes: <span id="total-likes">0</span></p>
                <ol id="likes-list"></ol>
                <button id="load-likes">Show Likes</button>
            </div>
        </div>

        <!-- Unlikes -->
        <div class="section-box">
            <h3 onclick="toggleSection('unlikes-section')">üëé UnLikes</h3>
            <div id="unlikes-section" class="hidden">
                <p>Total Unlikes: <span id="total-unlikes">0</span></p>
                <ol id="unlikes-list"></ol>
                <button id="load-unlikes">Show Unlikes</button>
            </div>
        </div>

        <hr>

        <button id="delete-account" style="background:#d11a2a;color:white;padding:10px;border:none;border-radius:5px;">
            Delete Account
        </button>

        <button id="back">Back</button>
        <button id="logout">Logout</button>

    </div>

<div id="edit-profile" style="display: none;">
    Name:<input type="text" id="edit-name" placeholder="Enter Your Name">
    email:<input type="email"id='edit-email' placeholder="Enter Your Email">
   <button id="submit-profile-btn">Submit</button>
    <button id="cancel-btn">Cancel</button>
  </div>
<!-- EDIT POST FORM (HIDDEN INITIALLY) -->
<div id="edit-form-box" style="display:none; margin:20px; padding:15px; border:1px solid #ccc; border-radius:10px; background:#fff;">
    <h3>Edit Post</h3>

    <label>Title:</label>
    <input type="text" id="edit-title" style="width:100%; padding:8px;"><br><br>

    <label>Description:</label>
    <textarea id="edit-description" style="width:100%; height:80px;"></textarea><br><br>

    <label>Category:</label>
    <input type="text" id="edit-category" style="width:100%; padding:8px;"><br><br>

    <label>Change Image (optional):</label>
    <input type="file" id="edit-image"><br><br>

    <button onclick="saveEditedPost()" style="background:green; padding:8px 15px; border:none; color:white; border-radius:6px;">Save Changes</button>
    <button onclick="closeEditForm()" style="background:gray; padding:8px 15px; border:none; color:white; border-radius:6px;">Cancel</button>
</div>
  <div id="posts"></div>
 
<script>
const BASE = window.location.origin;
// Toggle Sections
function toggleSection(id) {
    const box = document.getElementById(id);
    box.classList.toggle("hidden");
}

// PROFILE INFO 

const nameSpan = document.getElementById('acc-name');
const emailSpan = document.getElementById('acc-email');
const editProfilebtn=document.getElementById("edit-profile-btn");
const likesList = document.getElementById('likes-list');
const unlikesList = document.getElementById('unlikes-list');
const savedList = document.getElementById('saved-list');
const myPostsList = document.getElementById('myposts-list');
const submiteditProfile = document.getElementById("submit-profile-btn");
const accountBtn = document.getElementById('account-btn');
const accountDetails = document.getElementById('account-details');
const profileImg = document.getElementById('profile-img');

document.getElementById('addprofile-image').addEventListener('click', () => {
    document.getElementById('profile-file').click();
});

document.getElementById('profile-file').addEventListener('change', async function () {

    const file = this.files[0];
    console.log(document.getElementById('profile-file').files[0]);

    const formData = new FormData();
    formData.append("image", file);

    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE}/user/upload-profile`, {
        method: "PUT",
        headers: {
            "Authorization": `Bearer ${token}`
        },
        body: formData
    });

    const data = await res.json();
    if (data.imageUrl) {
        document.getElementById('profile-img').src = data.imageUrl;
        alert("Profile Image Updated");
    }
});

editProfilebtn.addEventListener('click',async(e)=>{
  e.preventDefault();
  document.getElementById('edit-profile').style.display = 'block';
});

submiteditProfile.addEventListener('click',async(e)=>{
  e.preventDefault();
try{
  
  const name=document.getElementById('edit-name').value;
  const email=document.getElementById('edit-email').value;

    const token=localStorage.getItem('token')
const res=await fetch(`${BASE}/user/edit-profile`,{
  method:'POST',
headers: {'Authorization': `Bearer ${token}`,
'Content-Type':'application/json'},
body:JSON.stringify({name,email}),
});

const data=await res.json();
if(!res.ok)
{
  alert('unable to edit')
}
else {
   document.getElementById('edit-profile').style.display = 'none';
    document.getElementById('account-details').style.display = "none";
     document.getElementById('acc-name').textContent = data.user.name;
    document.getElementById('acc-email').textContent = data.user.email;

    alert('Profile updated successfully!');
    }

  }
  catch(err)
  {
    console.log('err',err);
  }
})
editProfilebtn.addEventListener("click", async () => {
  try {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE}/user/edit-profile`, {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();

    if (res.ok) {
      // Prefill form fields
      document.getElementById("edit-name").value = data.name;
      document.getElementById("edit-email").value = data.email;

      document.getElementById("edit-profile").style.display = "block";
    } else {
      alert("Unable to load profile details");
    }

  } catch (err) {
    console.log("Error:", err);
  }
});



async function loadAllPosts() {
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${BASE}/post/getPost`, {
      headers: {'Authorization': `Bearer ${token}` }
    });
if(!token)
{
    window.location.href='./login.html'
}
    if (!res.ok) throw new Error('Failed to fetch posts');
    const posts = await res.json();
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';

    for (const p of posts) {
      const div = document.createElement('div');
      div.classList.add('card');
      div.dataset.postId = p.id;
      const postedTime = new Date(p.createdAt).toLocaleString();

      div.innerHTML = `
      
<img src="${
  p.image.startsWith('http://') || p.image.startsWith('https://')
    ? p.image
    : `${BASE}${p.image}`
}" alt="Post Image" class="post-image">

        <div class="card-content">
          <h2>${p.title}</h2>
          <p>${p.description}</p>
          <div class="footer">
            <span>üïí ${postedTime}</span>
            <span>By: ${p.user ? p.user.name : 'Unknown'}</span>
          </div>
          <div class="actions">
            <button class="like-btn">‚ù§ Like (<span class="like-count">0</span>)</button>
            <button class="dislike-btn">üíî Dislike (<span class="dislike-count">0</span>)</button>
           <button 
  class="save-btn" id="save-${p.id}" data-saved="false"  onclick="savePost(${p.id})"> Save</button>

            <button class="comment-btn">üí¨ Comment</button>
            <button class="share-btn">üîó Share</button>
          </div>
          <div class="comment-list" style="display:none"></div>
        </div>
      `;

      postsDiv.appendChild(div);
 checkSaveStatus(p.id);
      // --- Load like/dislike counts + user reaction ---
      try {
        const likeRes = await fetch(`${BASE}/like-comment/likes/${p.id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const { likes, dislikes, userReaction } = await likeRes.json();
        div.querySelector('.like-count').textContent = likes;
        div.querySelector('.dislike-count').textContent = dislikes;

        // Highlight user reaction
        if (userReaction === 'like') div.querySelector('.like-btn').style.backgroundColor = 'green';
        if (userReaction === 'dislike') div.querySelector('.dislike-btn').style.backgroundColor = 'red';
      } catch (err) {
        console.log('Error loading likes:', err);
      }

      // --- Like button ---
      div.querySelector('.like-btn').addEventListener('click', async () => {
        try {
          const res = await fetch(`${BASE}/like-comment/like`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ postId: p.id, type: 'like' })
          });
          if (!res.ok) throw new Error('Failed to like');
          // Fetch updated like/dislike count for only this post
    const lRes = await fetch(`${BASE}/like-comment/likes/${p.id}`, {
      headers: { 'Authorization':`Bearer ${token}` }
    });
      const { likes, dislikes, userReaction } = await lRes.json();

    // Update UI for this post only
    div.querySelector('.like-count').textContent = likes;
    div.querySelector('.dislike-count').textContent = dislikes;

    // Set button colors
    div.querySelector('.like-btn').style.backgroundColor =
      userReaction === "like" ? "green" : "";

    div.querySelector('.dislike-btn').style.backgroundColor =
      userReaction === "dislike" ? "red" : "";

        } catch (err) {
          console.error(err);
          alert('Error liking post');
        }
      });

      // --- Dislike button ---
      div.querySelector('.dislike-btn').addEventListener('click', async () => {
        try {
          const res = await fetch(`${BASE}/like-comment/like`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ postId: p.id, type: 'dislike' })
          });
          if (!res.ok) throw new Error('Failed to dislike');
        const lRes = await fetch(`${BASE}/like-comment/likes/${p.id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
      const { likes, dislikes, userReaction } = await lRes.json();

    // Update UI for this post only
    div.querySelector('.like-count').textContent = likes;
    div.querySelector('.dislike-count').textContent = dislikes;

    // Set button colors
    div.querySelector('.like-btn').style.backgroundColor =
      userReaction === "like" ? "green" : "";

    div.querySelector('.dislike-btn').style.backgroundColor =
      userReaction === "dislike" ? "red" : "";
        } catch (err) {
          console.error(err);
          alert('Error disliking post');
        }
      });

      // --- Comment button ---
      const commentBtn = div.querySelector('.comment-btn');
      const commentList = div.querySelector('.comment-list');

      commentBtn.addEventListener('click', async () => {
        // Toggle visibility
        if (commentList.style.display === 'none') {
          commentList.style.display = 'block';
          await loadComments(p.id, commentList, token);
        } else {
          commentList.style.display = 'none';
        }
      });

      // --- Share button ---
      div.querySelector('.share-btn').addEventListener('click', async () => {
        const shareData = {
          title: p.title,
          text: p.description,
          url: window.location.href
        };
        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareData.url);
            alert('Link copied to clipboard!');
          }
        } catch (err) {
          console.log('Share failed:', err);
        }
      });
    }
  } catch (err) {
    console.error(err);
    alert('Error loading posts');
  }
}


    loadAllPosts();
/* Toggle account card */

   accountBtn.addEventListener("click", async(e) => {
   
    e.preventDefault();
  if (accountDetails.style.display === "none" || accountDetails.style.display === "") {
    accountDetails.style.display = "block";
    loadAccountDetails();
  } else {
    accountDetails.style.display = "none";
  }


});

/* Load Profile */
async function loadAccountDetails() {
    try {
        const token = localStorage.getItem('token');
        if (!token) return;

        const res = await fetch(`${BASE}/user/profile`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        const user = await res.json();
console.log('user image',user.profileImage);
        nameSpan.textContent = user.name;
        emailSpan.textContent = user.email;
        lastLoginSpan.textContent = user.lastLogin || "Today";

        if (user.profileImage) profileImg.src = user.profileImage;

        localStorage.setItem("role", user.role);
        localStorage.setItem("userId", user.id);

    } catch (err) {
        console.error("Error loading account:", err);
    }
}




/* ---------------- YOUR POSTS ---------------- */
async function loadMyPosts() {
    try {
      
        const token = localStorage.getItem("token");
        const userId = localStorage.getItem("userId");
        const role = localStorage.getItem("role");

        const res = await fetch(`${BASE}/post/my-posts`, {
            method:'GET',
            headers: { Authorization: `Bearer ${token}` },
        });

        const data = await res.json();
        myPostsList.innerHTML = "";
console.log('posts',data)
      if ( data.posts.length === 0) {
    myPostsList.innerHTML = "No posts created by you.";
    return;
}

data.posts.forEach(post => {

            const div = document.createElement("div");
            div.className = "post-item";

            div.innerHTML = `
                <span>${post.title}</span>
                <span>
                    <button class="post-btn edit-btn" onclick="editPost(${post.id})">Edit</button>
                    <button class="post-btn delete-btn" onclick="deletePost(${post.id})">Delete</button>
                </span>
            `;
            
            myPostsList.appendChild(div);
        });

    } catch (err) {
        console.log(err);
    }
}

async function editPost(postId) {
    try {document.getElementById("edit-form-box").style.display = "block";
        const token = localStorage.getItem("token");

        const res = await fetch(`${BASE}/post/edit/${postId}`, {
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
        });

        const data = await res.json();

        if (!res.ok) {
            alert("Unable to load post");
            return;
        }

        console.log("Editing Post:", data.post);

        // Fill form fields
        document.getElementById("edit-title").value = data.post.title;
        document.getElementById("edit-description").value = data.post.description;
        document.getElementById("edit-category").value = data.post.category;

        localStorage.setItem("editPostId", postId);

       

    } catch (err) {
        console.log(err);
    }
}

/* DELETE POST */
async function deletePost(postId) {
    if (!confirm("Are you sure you want to delete this post?")) return;

    try {
        const token = localStorage.getItem("token");

        await fetch(`${BASE}/post/delete/${postId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` }
        });

        alert("Post deleted!");
        loadMyPosts();

    } catch (err) {
        console.log(err);
    }
}


/* ---------------- LIKES ---------------- */
document.getElementById("load-likes").addEventListener("click", async () => {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE}/like-comment/user-likes`, {
        headers: { Authorization: `Bearer ${token}` },
    });

    const data = await res.json();

    likesList.innerHTML = "";
    if (!data.likes?.length) {
        likesList.innerHTML = "<li>No likes found</li>";
        return;
    }

    document.getElementById("total-likes").textContent = data.likes.length;

    data.likes.forEach(post => {
        const li = document.createElement("li");
        li.textContent = post?.title || "Untitled Post";
        likesList.appendChild(li);
    });
});

/* ---------------- UNLIKES ---------------- */
document.getElementById("load-unlikes").addEventListener("click", async () => {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE}/like-comment/user-unlikes`, {
        headers: { Authorization: `Bearer ${token}` },
    });

    const data = await res.json();

    unlikesList.innerHTML = "";
    if (!data.unlikes?.length) {
        unlikesList.innerHTML = "<li>No unlikes found</li>";
        return;
    }

    document.getElementById("total-unlikes").textContent = data.unlikes.length;

    data.unlikes.forEach(post => {
        const li = document.createElement("li");
        li.textContent = post?.title || "Untitled Post";
        unlikesList.appendChild(li);
    });
});

async function loadComments(postId, commentList, token) {
  try {
    const res = await fetch(`${BASE}/like-comment/comments/${postId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) return;
    const comments = await res.json();
    commentList.innerHTML = comments.map(c =>
      `<p><strong>${c.user?.name || 'User'}:</strong> ${c.comment}</p>`
    ).join('');

    // Add comment box
    const addBox = document.createElement('div');
    addBox.innerHTML = `
      <input type="text" placeholder="Write a comment..." id="commentInput-${postId}" style="width:70%">
      <button id="addCommentBtn-${postId}">Post</button>
    `;
    commentList.appendChild(addBox);

    document.getElementById(`addCommentBtn-${postId}`).addEventListener('click', async () => {
      const commentText = document.getElementById(`commentInput-${postId}`).value.trim();
      if (!commentText) return;
      const r = await fetch(`${BASE}/like-comment/comment`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ postId, comment: commentText })
      });
      if (r.ok) await loadComments(postId, commentList, token);
    });
  } catch (err) {
    console.error('Error loading comments:', err);
  }
}
/* ---------------- DELETE ACCOUNT ---------------- */
document.getElementById("delete-account").addEventListener("click", async () => {
    
    if (!confirm("Are you sure? This action cannot be undone.")) return;

    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE}/user/delete-account`, {
        method: "DELETE",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    });

    const data = await res.json();

    if (res.ok) {
        alert("Your account has been deleted.");
        localStorage.removeItem("token");
        window.location.href = "./signup.html";   // redirect
    } else {
        alert("Error deleting account: " + data.message);
    }
});
function closeEditForm() {
    document.getElementById("edit-form-box").style.display = "none";
}

/* ---------------- LOGOUT ---------------- */
document.getElementById("logout").addEventListener("click", () => {
    localStorage.removeItem("token");
    window.location.href = "./login.html";
});

document.getElementById("back").addEventListener("click", () => {
    window.location.href = "dashboard.html";
});
async function saveEditedPost() {
    const postId = localStorage.getItem("editPostId");
    const token = localStorage.getItem("token");

    const title = document.getElementById("edit-title").value;
    const description = document.getElementById("edit-description").value;
    const category = document.getElementById("edit-category").value;
    const imageFile = document.getElementById("edit-image").files[0];

    const formData = new FormData();
    formData.append("title", title);
    formData.append("description", description);
    formData.append("category", category);

    if (imageFile) {
        formData.append("image", imageFile); // only when changed
    }

    const res = await fetch(`${BASE}/post/update/${postId}`, {
        method: "PUT",
        headers: { Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
 },
        body: formData
    });

    const data = await res.json();

    if (!res.ok) {
        alert(data.message || "Update failed");
        return;
    }

    alert("Post updated!");
    closeEditForm();
    loadMyPosts();
}
async function savePost(postId) {
  try {
    const token = localStorage.getItem("token");

    // select correct button
    const btn = document.querySelector(`#save-${postId}`);

    // check current state
    const isSaved = btn.getAttribute("data-saved") === "true";

    // decide next action
    const action = isSaved ? "unsave" : "save";

    const res = await fetch(`${BASE}/post/save/${postId}`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ type: action })
    });

    const data = await res.json();

    if (res.ok) {
      if (data.type === "save") {
        btn.style.backgroundColor = "white";
        btn.textContent = "Saved";
        btn.setAttribute("data-saved", "true");
      } else {
        btn.style.backgroundColor = "transparent";
        btn.textContent = "Save";
        btn.setAttribute("data-saved", "false");
      }
    }

  } catch (err) {
    console.log(err);
  }
}
async function checkSaveStatus(postId) {
  const token = localStorage.getItem("token");
  const btn = document.querySelector(`#save-${postId}`);

  try {
    const res = await fetch(`${BASE}/post/save/${postId}`, {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();

    if (data.isSaved) {
      btn.style.backgroundColor = "white";
      btn.textContent = "Saved";
      btn.setAttribute("data-saved", "true");
    } else {
      btn.style.backgroundColor = "transparent";
      btn.textContent = "Save";
      btn.setAttribute("data-saved", "false");
    }

  } catch (err) {
    console.log(err);
  }
}



async function loadSavedPosts() {
  try {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE}/post/saved`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    const savedPosts = data.posts;

    const container = document.getElementById("saved-Posts");
    container.innerHTML = "";

    if (!savedPosts || savedPosts.length === 0) {
      container.innerHTML = "<h3>No saved posts found</h3>";
      return;
    }

    savedPosts.forEach((p) => {
      container.innerHTML += `
        <div class="post-card">
           
            <h3>${p.title}</h3>
            <p>${p.description}</p>
        </div>
      `;
    });

  } catch (err) {
    console.log(err);
  }
}

loadSavedPosts();

</script>

</body>
</html> 